import { useChannels } from '@/hooks/useChannels'
import { createFileRoute, useNavigate } from '@tanstack/react-router'
import { Hash, Loader2, RotateCwIcon, Settings, Users, X } from 'lucide-react'
import { Skeleton } from "@/components/ui/skeleton"
import { ChatInterface } from '@/components/chat/ChatInterface'
import { Button } from '@/components/ui/button'
import { useId, useState } from 'react'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
  DialogDescription
} from "@/components/ui/dialog"
import { Label } from '@/components/ui/label'
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group'
import { toast } from 'sonner'
import { Input } from '@/components/ui/input'
import { cn } from '@/lib/utils'

export const Route = createFileRoute('/(channels)/channels/$id')({
  component: RouteComponent,
})

function RouteComponent() {
  const { id } = Route.useParams()
  const { channel, channelLoading, leaveChannel, changeType, changeTypeLoading, changeName, changeNameLoading } = useChannels(id)
  const navigate = useNavigate()
  const priId = useId()
  const pubId = useId()

  const [dialogOpen, setDialogOpen] = useState(false)
  const [showMembers, setShowMembers] = useState(false)
  const [accessType, setAccessType] = useState<string>(channel?.access_type ?? 'public')
  const [newName, setNewName] = useState(channel?.name ?? "")
  const members = channel?.members ?? []

  const handleAccessType = () => {
    if (accessType == channel?.access_type) {
      toast.info("Acces type remains same")
      return
    }
    changeType(id, accessType)
    setDialogOpen(false)
  }

  const handleChangeName = () => {
    const newChannelName = newName.trim()
    if (newChannelName == channel?.name) {
      toast.info("DevSpace name remains same")
      return
    }
    changeName(id, newName)
    setDialogOpen(false)
  }

  return (
    <div className="flex-1 flex h-full">

      <div className="flex-1 flex flex-col min-w-0">
        <div className="h-12 px-4 flex items-center border-b border-border bg-secondary">
          {channelLoading ? (
            <div className="flex items-center space-x-2">
              <Skeleton className="h-5 w-5 rounded-md" />
              <Skeleton className="h-4 w-32" />
            </div>
          ) : channel ? (
            <div className='w-full flex items-center justify-between'>
              <div className='flex items-center'>
                <Hash className="h-5 w-5 text-muted-foreground mr-2" />
                <span className="font-semibold">{channel.name}</span>
                <Button
                  variant='outline'
                  onClick={() => setShowMembers(!showMembers)}
                  className="gap-2 cursor-pointer ml-4"
                >
                  <Users className="h-4 w-4" />
                  {channel.member_count}{" "}
                  {channel.member_count === 1 ? "member" : "members"}
                </Button>
              </div>

              <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>
                <DialogTrigger asChild>
                  <Button variant="ghost" className='ml-4'><Settings /></Button>
                </DialogTrigger>
                <DialogContent className="sm:max-w-[425px]">
                  <DialogHeader>
                    <DialogTitle>Settings</DialogTitle>
                  </DialogHeader>
                  <DialogDescription>
                    Change the settings of your DevSpace
                  </DialogDescription>
                  <div className="grid gap-2 space-y-2 border border-border p-2 rounded-lg">
                    <p className="text-primary">Channel Name</p>

                    <div className='flex items-center gap-2'>
                      <Input
                        placeholder="Enter new channel name"
                        value={newName}
                        onChange={(e) => setNewName(e.target.value)}
                        className=''
                      />
                      <Button
                        onClick={() => setNewName(channel.name)}
                        disabled={newName === channel.name}
                        className={cn(
                          "p-2 rounded-xl border border-border transition-colors",
                          newName !== channel.name
                            ? "text-background bg-muted-foreground cursor-not-allowed opacity-50"
                            : "text-primary bg-background hover:bg-accent hover:text-accent-foreground cursor-pointer"
                        )}
                      >
                        <RotateCwIcon className="h-4 w-4" />
                      </Button>
                    </div>
                    <Button
                      onClick={handleChangeName}
                      disabled={changeNameLoading || !newName.trim()}
                    >
                      {changeNameLoading ? <Loader2 className="animate-spin h-4 w-4" /> : "Change Name"}
                    </Button>
                  </div>
                  <div className="grid gap-2 space-y-2 border border-border p-2 rounded-lg">
                    <p className="text-primary">Access Type</p>
                    <RadioGroup
                      defaultValue={pubId}
                      value={accessType}
                      onValueChange={setAccessType}
                      className="flex items-center gap-6"
                    >
                      <div className="flex items-center space-x-2">
                        <RadioGroupItem value="public" id={pubId} />
                        <Label htmlFor={pubId}>Public</Label>
                      </div>
                      <div className="flex items-center space-x-2">
                        <RadioGroupItem value="private" id={priId} />
                        <Label htmlFor={priId}>Private</Label>
                      </div>
                    </RadioGroup>

                    <Button onClick={handleAccessType} disabled={changeTypeLoading}>{changeTypeLoading ? <Loader2 className='animate-spin' /> : "Change Access Type"}</Button>
                  </div>
                  <Button variant='destructive' onClick={() => {
                    setDialogOpen(false)
                    leaveChannel(channel.id)
                    navigate({ to: "/channels/@dev" })
                  }}>
                    Leave {channel.name}
                  </Button>
                </DialogContent>
              </Dialog>
            </div>
          ) : (
            <p className="text-muted-foreground">Channel not found</p>
          )}
        </div>

        {channelLoading ? (
          <div className="flex-1 p-4 space-y-4">
            <Skeleton className="h-16 w-full" />
            <Skeleton className="h-16 w-full" />
            <Skeleton className="h-16 w-full" />
          </div>
        ) : channel ? (
          <div className='flex-1 flex'>
            <ChatInterface channelId={channel.id} channelName={channel.name} />
          </div>
        ) : (
          <div className="flex-1 flex items-center justify-center text-muted-foreground">
            <p>Channel not found</p>
          </div>
        )}
      </div>

      {showMembers && channel && (
        <div className="w-60 border-l border-border bg-secondary flex flex-col">
          <div className="h-12 px-4 flex items-center justify-between border-b border-border">
            <span className="font-semibold text-sm">Members</span>

            <Button
              variant="ghost"
              size="icon"
              className="h-8 w-8"
              onClick={() => setShowMembers(false)}
            >
              <X className="h-4 w-4" />
            </Button>
          </div>

          <div className="flex-1 overflow-y-auto p-2">
            <div className="space-y-1">
              {channelLoading ? (
                <p className="text-sm text-muted-foreground">Loading...</p>
              ) : (
                members.map(member => {
                  const isAdmin = member.id === channel.admin.id
                  return (
                    <div
                      key={member.id}
                      className="px-2 py-1.5 rounded hover:bg-accent flex items-center gap-2"
                    >
                      {
                        isAdmin ?
                          <div className="h-8 w-8 rounded-full bg-primary text-primary-foreground flex items-center justify-center">
                            {member.username?.[0]?.toUpperCase() ?? ""}
                          </div>
                          :
                          <div className="h-8 w-8 text-primary flex items-center justify-center">
                            {member.username?.[0]?.toUpperCase() ?? ""}
                          </div>
                      }

                      <span className="text-sm">
                        {member.username}
                        {isAdmin && " (Host)"}
                      </span>
                    </div>
                  )
                })
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  )
}
